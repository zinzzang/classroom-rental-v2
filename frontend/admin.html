<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê°•ì˜ì‹¤ ëŒ€ì—¬ - ê´€ë¦¬ì</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="max-w-6xl mx-auto p-6">
  <div class="flex items-end justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-bold">ê´€ë¦¬ì ì‹œìŠ¤í…œ</h1>
      <p class="text-gray-600 mt-1">ê°•ì˜ì‹¤/ì¼ì • ê´€ë¦¬ + ìŠ¹ì¸/ë°˜ë ¤ + ìˆ˜ì •/ì‚­ì œ</p>
    </div>
    <div class="text-sm text-gray-600">API: <span id="apiBaseLabel"></span></div>
  </div>

  <!-- ë¡œê·¸ì¸ -->
  <div id="loginBox" class="bg-white rounded shadow p-5 mb-6">
    <h2 class="text-xl font-semibold mb-3">ë¡œê·¸ì¸</h2>
    <div class="grid grid-cols-2 gap-3 max-w-xl">
      <input id="username" class="border rounded p-2" placeholder="username (ê¸°ë³¸: admin)" />
      <input id="password" type="password" class="border rounded p-2" placeholder="password (ê¸°ë³¸: admin1234)" />
    </div>
    <div class="mt-4 flex gap-3 items-center">
      <button id="loginBtn" class="px-4 py-2 bg-gray-900 text-white rounded">ë¡œê·¸ì¸</button>
      <span id="loginMsg" class="text-sm"></span>
    </div>
  </div>

  <!-- ì•± -->
  <div id="app" class="hidden space-y-6">
    <div class="flex gap-3">
      <button id="tabRooms" class="px-4 py-2 rounded bg-blue-600 text-white">ê°•ì˜ì‹¤ ê´€ë¦¬</button>
      <button id="tabSchedules" class="px-4 py-2 rounded bg-white border">ì¼ì • ê´€ë¦¬</button>
      <button id="tabStats" class="px-4 py-2 rounded bg-white border">í†µê³„/ê´€ë¦¬</button>
      <button id="logoutBtn" class="ml-auto px-4 py-2 rounded bg-white border">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- ê°•ì˜ì‹¤ -->
    <div id="roomsPanel" class="bg-white rounded shadow p-5">
      <div class="flex items-end justify-between mb-4">
        <h2 class="text-xl font-semibold">ê°•ì˜ì‹¤ ëª©ë¡</h2>
        <button id="reloadRooms" class="px-3 py-2 rounded bg-gray-800 text-white text-sm">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div class="grid md:grid-cols-3 gap-3 mb-3">
        <input id="newRoomCode" class="border rounded p-2" placeholder="room_code (ì˜ˆ: 301 / CONFERENCE)" />
        <input id="newDisplayName" class="border rounded p-2" placeholder="í‘œì‹œëª… (ì˜ˆ: 301(40) S)" />
        <input id="newCapacity" class="border rounded p-2" placeholder="ìˆ˜ìš© ì¸ì› (ì˜ˆ: 40)" />
      </div>
      <button id="addRoomBtn" class="px-4 py-2 bg-green-600 text-white rounded">ê°•ì˜ì‹¤ ì¶”ê°€</button>
      <span id="roomsMsg" class="text-sm ml-3"></span>

      <div class="mt-5 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b">
              <th class="py-2">ì½”ë“œ</th><th>í‘œì‹œëª…</th><th>ìˆ˜ìš©</th><th>ìƒíƒœ</th><th class="text-right">ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody id="roomsTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ì¼ì • -->
    <div id="schedulesPanel" class="bg-white rounded shadow p-5 hidden">
      <div class="flex flex-wrap items-end justify-between gap-4 mb-4">
        <h2 class="text-xl font-semibold">ì¼ì • ëª©ë¡ / ìŠ¹ì¸ / ìˆ˜ì •</h2>
        <button id="reloadSchedules" class="px-3 py-2 rounded bg-gray-800 text-white text-sm">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div class="flex flex-wrap gap-3 items-end mb-4">
        <div>
          <label class="text-sm font-semibold">ë‚ ì§œ</label>
          <input id="filterDate" type="date" class="border rounded p-2 block" />
        </div>
        <div>
          <label class="text-sm font-semibold">ìƒíƒœ</label>
          <select id="filterStatus" class="border rounded p-2 block">
            <option value="">ì „ì²´</option>
            <option value="PENDING">PENDING</option>
            <option value="APPROVED">APPROVED</option>
            <option value="REJECTED">REJECTED</option>
          </select>
        </div>
      </div>

      <!-- ê´€ë¦¬ì ì¼ì • ì¶”ê°€ -->
      <div class="border rounded p-4 mb-5">
        <div class="font-semibold mb-2">ê´€ë¦¬ì ì¼ì • ì¶”ê°€(ìˆ˜ì—…/í–‰ì‚¬) - ë‚ ì§œ ë²”ìœ„ ì„ íƒ ê°€ëŠ¥</div>
        <div class="grid md:grid-cols-4 gap-3">
          <select id="addRoom" class="border rounded p-2"></select>
          <input id="addDateStart" type="date" class="border rounded p-2" placeholder="ì‹œì‘ ë‚ ì§œ" />
          <input id="addDateEnd" type="date" class="border rounded p-2" placeholder="ì¢…ë£Œ ë‚ ì§œ (ê°™ì€ ë‚ ì´ë©´ ë¹„ì›Œë‘ì„¸ìš”)" />
          <div class="text-xs text-gray-500 flex items-center">ë‚ ì§œ ë²”ìœ„ ë‚´ ëª¨ë“  ë‚ ì§œì— ì¶”ê°€ë©ë‹ˆë‹¤</div>
          <input id="addStart" class="border rounded p-2" placeholder="start HH:MM (ì˜ˆ: 09:00)" />
          <input id="addEnd" class="border rounded p-2" placeholder="end HH:MM (ì˜ˆ: 10:30)" />
          <input id="addCategory" class="border rounded p-2 md:col-span-2" placeholder="category (CLASS/SEMINAR/...)" />
          <input id="addTitle" class="border rounded p-2 md:col-span-4" placeholder="title (ìˆ˜ì—…/í–‰ì‚¬ëª…)" />
          <input id="addOwnerName" class="border rounded p-2" placeholder="ë‹´ë‹¹ì ì´ë¦„" />
          <input id="addOwnerOrg" class="border rounded p-2" placeholder="ì†Œì†" />
          <input id="addStatus" class="border rounded p-2 md:col-span-2" placeholder="status (APPROVED/PENDING)" />
          <input id="addMemo" class="border rounded p-2 md:col-span-4" placeholder="memo (ë¹„ê³ )" />
        </div>
        <div class="mt-3">
          <button id="addScheduleBtn" class="px-4 py-2 bg-blue-600 text-white rounded">ì¼ì • ì¶”ê°€</button>
          <span id="schedMsg" class="text-sm ml-3"></span>
        </div>
      </div>

      <div id="schedList" class="space-y-3"></div>

      <!-- í¸ì§‘ ëª¨ë‹¬ -->
      <div id="editModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-6">
        <div class="bg-white rounded shadow max-w-2xl w-full p-5">
          <h3 class="text-lg font-semibold mb-3">ì¼ì • ìˆ˜ì •</h3>
          <div class="grid md:grid-cols-4 gap-3">
            <select id="editRoom" class="border rounded p-2"></select>
            <input id="editDate" type="date" class="border rounded p-2" />
            <input id="editStart" class="border rounded p-2" placeholder="HH:MM" />
            <input id="editEnd" class="border rounded p-2" placeholder="HH:MM" />
            <input id="editCategory" class="border rounded p-2" placeholder="category" />
            <input id="editTitle" class="border rounded p-2 md:col-span-3" placeholder="title" />
            <input id="editOwnerName" class="border rounded p-2" placeholder="owner_name" />
            <input id="editOwnerOrg" class="border rounded p-2" placeholder="owner_org" />
            <input id="editStatus" class="border rounded p-2" placeholder="status" />
            <input id="editMemo" class="border rounded p-2 md:col-span-4" placeholder="memo" />
          </div>
          <div class="mt-4 flex gap-3 justify-end">
            <button id="editCancel" class="px-4 py-2 rounded border">ì·¨ì†Œ</button>
            <button id="editSave" class="px-4 py-2 rounded bg-blue-600 text-white">ì €ì¥</button>
          </div>
          <div class="mt-2"><span id="editMsg" class="text-sm"></span></div>
        </div>
      </div>

      <!-- ë°˜ë ¤ ëª¨ë‹¬ -->
      <div id="rejectModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-6">
        <div class="bg-white rounded shadow max-w-lg w-full p-5">
          <h3 class="text-lg font-semibold mb-3">ë°˜ë ¤ ì‚¬ìœ </h3>
          <textarea id="rejectReason" class="border rounded p-2 w-full h-28" placeholder="ë°˜ë ¤ ì‚¬ìœ "></textarea>
          <div class="mt-4 flex gap-3 justify-end">
            <button id="rejectCancel" class="px-4 py-2 rounded border">ì·¨ì†Œ</button>
            <button id="rejectConfirm" class="px-4 py-2 rounded bg-red-600 text-white">ë°˜ë ¤</button>
          </div>
          <div class="mt-2"><span id="rejectMsg" class="text-sm"></span></div>
        </div>
      </div>

    <!-- í†µê³„/ê´€ë¦¬ -->
    <div id="statsPanel" class="bg-white rounded shadow p-5 hidden">
      <h2 class="text-xl font-semibold mb-4">ì‹œìŠ¤í…œ í†µê³„ ë° ê´€ë¦¬</h2>
      
      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div class="border rounded p-4">
          <div class="text-sm text-gray-600">ì´ ê°•ì˜ì‹¤</div>
          <div id="statRooms" class="text-3xl font-bold">-</div>
        </div>
        <div class="border rounded p-4">
          <div class="text-sm text-gray-600">ì´ ì¼ì •</div>
          <div id="statSchedules" class="text-3xl font-bold">-</div>
        </div>
        <div class="border rounded p-4">
          <div class="text-sm text-gray-600">ìŠ¹ì¸ ëŒ€ê¸°</div>
          <div id="statPending" class="text-3xl font-bold text-orange-600">-</div>
        </div>
      </div>

      <div class="border-t pt-4">
        <h3 class="font-semibold mb-3">ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬</h3>
        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
          <div class="flex items-start gap-3">
            <div class="text-yellow-600 text-2xl">âš ï¸</div>
            <div class="flex-1">
              <div class="font-semibold text-yellow-800">ì˜¤ë˜ëœ ì¼ì • ì •ë¦¬</div>
              <div class="text-sm text-yellow-700 mt-1">
                6ê°œì›” ì´ì „ ì¼ì •: <span id="statOld" class="font-bold">-</span>ê°œ
                <br>
                ë°ì´í„°ë² ì´ìŠ¤ í¬ê¸° ê´€ë¦¬ë¥¼ ìœ„í•´ ì˜¤ë˜ëœ ì¼ì •ì„ ì •ê¸°ì ìœ¼ë¡œ ì‚­ì œí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>
        
        <button id="cleanupBtn" class="px-4 py-2 bg-red-600 text-white rounded">
          6ê°œì›” ì´ì „ ì¼ì • ì‚­ì œ
        </button>
        <span id="cleanupMsg" class="text-sm ml-3"></span>
      </div>

      <div class="border-t pt-4 mt-6">
        <h3 class="font-semibold mb-3">ë°°í¬ ì •ë³´</h3>
        <div class="text-sm space-y-2 text-gray-700">
          <div><span class="font-semibold">API ì£¼ì†Œ:</span> <span id="deployUrl"></span></div>
          <div><span class="font-semibold">í™˜ê²½:</span> <span id="deployEnv"></span></div>
          <div class="text-xs text-gray-500 mt-3">
            ğŸ’¡ ë¬´ë£Œ í”Œëœ ì‚¬ìš© ì‹œ 15ë¶„ ë¯¸ì‚¬ìš©í•˜ë©´ ìŠ¬ë¦½ ëª¨ë“œì— ì§„ì…í•©ë‹ˆë‹¤. ì²« ì ‘ì† ì‹œ 30ì´ˆ~1ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

    </div>
  </div>
</div>

<script>
// í™˜ê²½ì— ë”°ë¼ ìë™ìœ¼ë¡œ API ì£¼ì†Œ ì„¤ì •
const API_BASE = window.location.origin;
document.getElementById("apiBaseLabel").textContent = API_BASE;

function setText(id, text, ok=true){
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = ok ? "text-sm text-green-700" : "text-sm text-red-700";
}
function todayStr(){ return new Date().toISOString().slice(0,10); }

function token(){ return localStorage.getItem("admin_token"); }
function authHeaders(){ return { "Authorization": `Bearer ${token()}`, "Content-Type":"application/json" }; }

async function fetchJSON(url, options={}){
  const res = await fetch(url, options);
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(data.detail || res.statusText);
  return data;
}

// tabs
function showRooms(){
  roomsPanel.classList.remove("hidden");
  schedulesPanel.classList.add("hidden");
  statsPanel.classList.add("hidden");
  tabRooms.className = "px-4 py-2 rounded bg-blue-600 text-white";
  tabSchedules.className = "px-4 py-2 rounded bg-white border";
  tabStats.className = "px-4 py-2 rounded bg-white border";
}
function showSchedules(){
  roomsPanel.classList.add("hidden");
  schedulesPanel.classList.remove("hidden");
  statsPanel.classList.add("hidden");
  tabSchedules.className = "px-4 py-2 rounded bg-blue-600 text-white";
  tabRooms.className = "px-4 py-2 rounded bg-white border";
  tabStats.className = "px-4 py-2 rounded bg-white border";
}
async function showStats(){
  roomsPanel.classList.add("hidden");
  schedulesPanel.classList.add("hidden");
  statsPanel.classList.remove("hidden");
  tabStats.className = "px-4 py-2 rounded bg-blue-600 text-white";
  tabRooms.className = "px-4 py-2 rounded bg-white border";
  tabSchedules.className = "px-4 py-2 rounded bg-white border";
  await loadStats();
}

async function login(){
  try{
    setText("loginMsg","");
    const username = usernameEl.value.trim() || "admin";
    const password = passwordEl.value.trim() || "admin1234";
    const data = await fetchJSON(`${API_BASE}/admin/login`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ username, password })
    });
    localStorage.setItem("admin_token", data.access_token);
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    await loadRooms();
    await loadSchedules();
  }catch(e){
    setText("loginMsg", e.message, false);
  }
}
function logout(){
  localStorage.removeItem("admin_token");
  location.reload();
}

// rooms
let roomsCache = [];
async function loadRooms(){
  try{
    setText("roomsMsg","");
    roomsCache = await fetchJSON(`${API_BASE}/admin/classrooms`, { headers: authHeaders() });

    // rooms table
    roomsTbody.innerHTML = "";
    roomsCache.forEach(r => {
      const badge = r.is_active
        ? `<span class="px-2 py-0.5 rounded bg-green-600 text-white text-xs">ACTIVE</span>`
        : `<span class="px-2 py-0.5 rounded bg-gray-500 text-white text-xs">INACTIVE</span>`;
      const btnLabel = r.is_active ? "ë¹„í™œì„±" : "í™œì„±";
      const btnClass = r.is_active ? "bg-gray-800" : "bg-blue-600";

      roomsTbody.innerHTML += `
        <tr class="border-b">
          <td class="py-2">${r.room_code}</td>
          <td>${r.display_name}</td>
          <td>${r.capacity}</td>
          <td>${badge}</td>
          <td class="text-right">
            <button class="toggleRoom px-3 py-1.5 rounded text-white ${btnClass}" data-id="${r.id}" data-active="${r.is_active}">
              ${btnLabel}
            </button>
          </td>
        </tr>
      `;
    });

    document.querySelectorAll(".toggleRoom").forEach(btn => {
      btn.addEventListener("click", async () => {
        try{
          const id = btn.getAttribute("data-id");
          const active = btn.getAttribute("data-active")==="true";
          await fetchJSON(`${API_BASE}/admin/classrooms/${id}`, {
            method:"PATCH",
            headers: authHeaders(),
            body: JSON.stringify({ is_active: !active })
          });
          await loadRooms();
          await fillRoomSelects();
        }catch(e){
          setText("roomsMsg", e.message, false);
        }
      });
    });

    await fillRoomSelects();
  }catch(e){
    setText("roomsMsg", e.message, false);
  }
}

async function addRoom(){
  try{
    setText("roomsMsg","");
    const room_code = newRoomCode.value.trim();
    const display_name = newDisplayName.value.trim();
    const capacity = Number(newCapacity.value || "0");
    if(!room_code || !display_name) return setText("roomsMsg","room_code/í‘œì‹œëª… ì…ë ¥ í•„ìš”", false);

    await fetchJSON(`${API_BASE}/admin/classrooms`, {
      method:"POST",
      headers: authHeaders(),
      body: JSON.stringify({ room_code, display_name, capacity })
    });
    setText("roomsMsg","ì¶”ê°€ ì™„ë£Œ", true);
    newRoomCode.value=""; newDisplayName.value=""; newCapacity.value="";
    await loadRooms();
  }catch(e){
    setText("roomsMsg", e.message, false);
  }
}

async function fillRoomSelects(){
  const opts = roomsCache.map(r => `<option value="${r.id}">${r.display_name}</option>`).join("");
  addRoomSel.innerHTML = opts;
  editRoomSel.innerHTML = opts;
}

// schedules
let editingId = null;
let rejectingId = null;

async function loadSchedules(){
  try{
    setText("schedMsg","");
    const qs = new URLSearchParams();
    if(filterDate.value) qs.set("date_str", filterDate.value);
    if(filterStatus.value) qs.set("status", filterStatus.value);

    const list = await fetchJSON(`${API_BASE}/admin/schedules?${qs.toString()}`, { headers: authHeaders() });
    schedList.innerHTML = "";

    if(list.length === 0){
      schedList.innerHTML = `<div class="p-3 rounded bg-gray-50 border text-sm">ì¼ì • ì—†ìŒ</div>`;
      return;
    }

    for(const it of list){
      const badge =
        it.status==="PENDING" ? `<span class="px-2 py-0.5 rounded bg-yellow-500 text-white text-xs">PENDING</span>` :
        it.status==="APPROVED" ? `<span class="px-2 py-0.5 rounded bg-green-600 text-white text-xs">APPROVED</span>` :
        `<span class="px-2 py-0.5 rounded bg-red-600 text-white text-xs">REJECTED</span>`;

      const actions = it.status==="PENDING"
        ? `
          <button class="approve px-3 py-1.5 rounded bg-green-600 text-white" data-id="${it.id}">ìŠ¹ì¸</button>
          <button class="reject px-3 py-1.5 rounded bg-red-600 text-white" data-id="${it.id}">ë°˜ë ¤</button>
        `
        : ``;

      schedList.innerHTML += `
        <div class="border rounded p-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div class="font-semibold">
              ${it.date} Â· ${it.display_name} Â· ${it.start_time}~${it.end_time} ${badge}
            </div>
            <div class="flex gap-2">
              ${actions}
              <button class="edit px-3 py-1.5 rounded border" data-id="${it.id}">ìˆ˜ì •</button>
              <button class="del px-3 py-1.5 rounded bg-gray-900 text-white" data-id="${it.id}">ì‚­ì œ</button>
            </div>
          </div>

          <div class="mt-2 text-sm text-gray-700 space-y-1">
            <div><span class="font-semibold">Category:</span> ${it.category}</div>
            <div><span class="font-semibold">Title:</span> ${it.title || "-"}</div>
            <div><span class="font-semibold">Owner:</span> ${it.owner_name || "-"} (${it.owner_org || "-"})</div>
            <div><span class="font-semibold">Memo:</span> ${it.memo || "-"}</div>
            ${it.reject_reason ? `<div class="text-red-700"><span class="font-semibold">Reject:</span> ${it.reject_reason}</div>` : ``}
          </div>
        </div>
      `;
    }

    document.querySelectorAll(".approve").forEach(b => b.addEventListener("click", () => approve(b.dataset.id)));
    document.querySelectorAll(".reject").forEach(b => b.addEventListener("click", () => openReject(b.dataset.id)));
    document.querySelectorAll(".edit").forEach(b => b.addEventListener("click", () => openEdit(b.dataset.id, list)));
    document.querySelectorAll(".del").forEach(b => b.addEventListener("click", () => delSchedule(b.dataset.id)));
  }catch(e){
    setText("schedMsg", e.message, false);
  }
}

async function addSchedule(){
  try{
    setText("schedMsg","");
    
    const startDate = addDateStart.value;
    const endDate = addDateEnd.value || startDate; // ì¢…ë£Œì¼ì´ ì—†ìœ¼ë©´ ì‹œì‘ì¼ê³¼ ê°™ìŒ
    
    if(!startDate || !addStart.value.trim() || !addEnd.value.trim()) {
      return setText("schedMsg","ì‹œì‘ë‚ ì§œ/start/end ì…ë ¥ í•„ìš”", false);
    }

    // ë‚ ì§œ ë²”ìœ„ ìƒì„±
    const dates = [];
    const current = new Date(startDate);
    const end = new Date(endDate);
    
    while(current <= end) {
      dates.push(current.toISOString().split('T')[0]);
      current.setDate(current.getDate() + 1);
    }

    setText("schedMsg", `${dates.length}ê°œ ë‚ ì§œì— ì¼ì • ì¶”ê°€ ì¤‘...`, true);

    // ê° ë‚ ì§œë§ˆë‹¤ ì¼ì • ì¶”ê°€
    let successCount = 0;
    let failedDates = [];
    
    for(const date of dates) {
      try {
        const payload = {
          classroom_id: Number(addRoomSel.value),
          date: date,
          start_time: addStart.value.trim(),
          end_time: addEnd.value.trim(),
          category: addCategory.value.trim() || "CLASS",
          title: addTitle.value.trim() || "",
          owner_name: addOwnerName.value.trim() || "",
          owner_org: addOwnerOrg.value.trim() || "",
          status: addStatus.value.trim() || "APPROVED",
          memo: addMemo.value.trim() || null
        };

        await fetchJSON(`${API_BASE}/admin/schedules`, {
          method:"POST",
          headers: authHeaders(),
          body: JSON.stringify(payload)
        });
        successCount++;
      } catch(e) {
        failedDates.push(date);
      }
    }

    if(failedDates.length > 0) {
      setText("schedMsg", `${successCount}ê°œ ì¶”ê°€ ì™„ë£Œ, ${failedDates.length}ê°œ ì‹¤íŒ¨: ${failedDates.join(', ')}`, false);
    } else {
      setText("schedMsg", `${successCount}ê°œ ë‚ ì§œì— ì¼ì • ì¶”ê°€ ì™„ë£Œ!`, true);
    }
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    addDateStart.value = "";
    addDateEnd.value = "";
    
    await loadSchedules();
  }catch(e){
    setText("schedMsg", e.message, false);
  }
}

async function approve(id){
  try{
    setText("schedMsg","");
    await fetchJSON(`${API_BASE}/admin/schedules/${id}/approve`, { method:"PATCH", headers: authHeaders() });
    setText("schedMsg","ìŠ¹ì¸ ì™„ë£Œ", true);
    await loadSchedules();
  }catch(e){
    setText("schedMsg", e.message, false);
  }
}

function openReject(id){
  rejectingId = id;
  rejectReason.value = "";
  rejectMsg.textContent = "";
  rejectModal.classList.remove("hidden");
  rejectModal.classList.add("flex");
}
function closeReject(){
  rejectModal.classList.add("hidden");
  rejectModal.classList.remove("flex");
  rejectingId = null;
}
async function confirmReject(){
  try{
    setText("rejectMsg","");
    const reason = rejectReason.value.trim();
    if(!reason) return setText("rejectMsg","ë°˜ë ¤ ì‚¬ìœ  ì…ë ¥ í•„ìš”", false);

    await fetchJSON(`${API_BASE}/admin/schedules/${rejectingId}/reject`, {
      method:"PATCH",
      headers: authHeaders(),
      body: JSON.stringify({ reject_reason: reason })
    });
    closeReject();
    setText("schedMsg","ë°˜ë ¤ ì™„ë£Œ", true);
    await loadSchedules();
  }catch(e){
    setText("rejectMsg", e.message, false);
  }
}

function openEdit(id, list){
  editingId = id;
  const it = list.find(x => String(x.id) === String(id));
  if(!it) return;

  editRoomSel.value = String(it.classroom_id);
  editDate.value = it.date;
  editStart.value = it.start_time;
  editEnd.value = it.end_time;
  editCategory.value = it.category || "";
  editTitle.value = it.title || "";
  editOwnerName.value = it.owner_name || "";
  editOwnerOrg.value = it.owner_org || "";
  editStatus.value = it.status || "";
  editMemo.value = it.memo || "";

  editMsg.textContent = "";
  editModal.classList.remove("hidden");
  editModal.classList.add("flex");
}
function closeEdit(){
  editModal.classList.add("hidden");
  editModal.classList.remove("flex");
  editingId = null;
}
async function saveEdit(){
  try{
    setText("editMsg","");
    const payload = {
      classroom_id: Number(editRoomSel.value),
      date: editDate.value,
      start_time: editStart.value.trim(),
      end_time: editEnd.value.trim(),
      category: editCategory.value.trim(),
      title: editTitle.value.trim(),
      owner_name: editOwnerName.value.trim(),
      owner_org: editOwnerOrg.value.trim(),
      status: editStatus.value.trim(),
      memo: editMemo.value.trim() || null
    };
    await fetchJSON(`${API_BASE}/admin/schedules/${editingId}`, {
      method:"PATCH",
      headers: authHeaders(),
      body: JSON.stringify(payload)
    });
    closeEdit();
    setText("schedMsg","ìˆ˜ì • ì™„ë£Œ", true);
    await loadSchedules();
  }catch(e){
    setText("editMsg", e.message, false);
  }
}

async function delSchedule(id){
  if(!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
  try{
    setText("schedMsg","");
    await fetchJSON(`${API_BASE}/admin/schedules/${id}`, { method:"DELETE", headers: authHeaders() });
    setText("schedMsg","ì‚­ì œ ì™„ë£Œ", true);
    await loadSchedules();
  }catch(e){
    setText("schedMsg", e.message, false);
  }
}

// DOM refs
const loginBox = document.getElementById("loginBox");
const app = document.getElementById("app");

const usernameEl = document.getElementById("username");
const passwordEl = document.getElementById("password");

const roomsPanel = document.getElementById("roomsPanel");
const schedulesPanel = document.getElementById("schedulesPanel");
const statsPanel = document.getElementById("statsPanel");
const tabRooms = document.getElementById("tabRooms");
const tabSchedules = document.getElementById("tabSchedules");
const tabStats = document.getElementById("tabStats");

const roomsTbody = document.getElementById("roomsTbody");
const newRoomCode = document.getElementById("newRoomCode");
const newDisplayName = document.getElementById("newDisplayName");
const newCapacity = document.getElementById("newCapacity");

const filterDate = document.getElementById("filterDate");
const filterStatus = document.getElementById("filterStatus");
const schedList = document.getElementById("schedList");

// add schedule inputs
const addRoomSel = document.getElementById("addRoom");
const addDateStart = document.getElementById("addDateStart");
const addDateEnd = document.getElementById("addDateEnd");
const addStart = document.getElementById("addStart");
const addEnd = document.getElementById("addEnd");
const addCategory = document.getElementById("addCategory");
const addTitle = document.getElementById("addTitle");
const addOwnerName = document.getElementById("addOwnerName");
const addOwnerOrg = document.getElementById("addOwnerOrg");
const addStatus = document.getElementById("addStatus");
const addMemo = document.getElementById("addMemo");

// edit modal
const editModal = document.getElementById("editModal");
const editRoomSel = document.getElementById("editRoom");
const editDate = document.getElementById("editDate");
const editStart = document.getElementById("editStart");
const editEnd = document.getElementById("editEnd");
const editCategory = document.getElementById("editCategory");
const editTitle = document.getElementById("editTitle");
const editOwnerName = document.getElementById("editOwnerName");
const editOwnerOrg = document.getElementById("editOwnerOrg");
const editStatus = document.getElementById("editStatus");
const editMemo = document.getElementById("editMemo");
const editMsg = document.getElementById("editMsg");

// reject modal
const rejectModal = document.getElementById("rejectModal");
const rejectReason = document.getElementById("rejectReason");
const rejectMsg = document.getElementById("rejectMsg");

// events
document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("logoutBtn").addEventListener("click", logout);

tabRooms.addEventListener("click", showRooms);
tabSchedules.addEventListener("click", showSchedules);
tabStats.addEventListener("click", showStats);

document.getElementById("reloadRooms").addEventListener("click", loadRooms);
document.getElementById("addRoomBtn").addEventListener("click", addRoom);

document.getElementById("reloadSchedules").addEventListener("click", loadSchedules);
filterDate.addEventListener("change", loadSchedules);
filterStatus.addEventListener("change", loadSchedules);

document.getElementById("addScheduleBtn").addEventListener("click", addSchedule);

document.getElementById("editCancel").addEventListener("click", closeEdit);
document.getElementById("editSave").addEventListener("click", saveEdit);

document.getElementById("rejectCancel").addEventListener("click", closeReject);
document.getElementById("rejectConfirm").addEventListener("click", confirmReject);

document.getElementById("cleanupBtn").addEventListener("click", cleanupOldSchedules);

// stats functions
async function loadStats(){
  try{
    const stats = await fetchJSON(`${API_BASE}/admin/stats`, { headers: authHeaders() });
    document.getElementById("statRooms").textContent = stats.total_classrooms;
    document.getElementById("statSchedules").textContent = stats.total_schedules;
    document.getElementById("statPending").textContent = stats.pending_schedules;
    document.getElementById("statOld").textContent = stats.old_schedules_count;
    
    document.getElementById("deployUrl").textContent = API_BASE;
    document.getElementById("deployEnv").textContent = API_BASE.includes("localhost") || API_BASE.includes("127.0.0.1") 
      ? "ë¡œì»¬ ê°œë°œ í™˜ê²½" 
      : "í´ë¼ìš°ë“œ ë°°í¬ í™˜ê²½";
  }catch(e){
    console.error("í†µê³„ ë¡œë“œ ì‹¤íŒ¨:", e);
  }
}

async function cleanupOldSchedules(){
  if(!confirm("6ê°œì›” ì´ì „ ì¼ì •ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
  
  try{
    setText("cleanupMsg", "ì‚­ì œ ì¤‘...", true);
    const result = await fetchJSON(`${API_BASE}/admin/schedules/cleanup/old`, {
      method: "DELETE",
      headers: authHeaders()
    });
    setText("cleanupMsg", `âœ… ${result.deleted_count}ê°œ ì¼ì • ì‚­ì œ ì™„ë£Œ (${result.cutoff_date} ì´ì „)`, true);
    await loadStats();
    await loadSchedules();
  }catch(e){
    setText("cleanupMsg", e.message, false);
  }
}

// init
filterDate.value = todayStr();
addDateStart.value = todayStr();
addCategory.value = "CLASS";
addStatus.value = "APPROVED";

(function boot(){
  if(token()){
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    loadRooms().then(loadSchedules);
  }
})();
</script>
</body>
</html>
